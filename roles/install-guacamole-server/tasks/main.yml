---

- name: Gather OS-specific variables
  include_vars: "{{ ansible_distribution }}.yml"
  tags: vars

- tags: install
  block:
  - name: Add Oracle Java repository
    apt_repository: repo="ppa:webupd8team/java"
    when: ansible_distribution == "Ubuntu"
  - name: Install epel-release for CentOS
    yum: name=epel-release state=latest update_cache=yes
    when: ansible_distribution == "CentOS"
  - name: Install dependencies for guacamole
    action: >
      {{ ansible_pkg_mgr }} name={{ item }} state=latest
    with_items: '{{ PACKAGES }}'

- name: Copy over guacamole-server source
  copy: src="files/guacamole-server-{{ GUACAMOLE_VERSION }}.tar.gz" dest=/tmp/
  tags: file

- name: Extract the guacamole-server source
  unarchive: src="/tmp/guacamole-server-{{ GUACAMOLE_VERSION }}.tar.gz" copy=no dest="/tmp/"
  tags: extract

- tags: build, install
  block: 
    - name: Build guacamole-server from source
      shell: ./configure --with-init-dir=/etc/init.d chdir=/tmp/guacamole-server-{{ GUACAMOLE_VERSION }}
    - name: Build guacamole-server from source
      shell: make chdir=/tmp/guacamole-server-{{ GUACAMOLE_VERSION }}
    - name: Build guacamole-server from source
      shell: make install chdir=/tmp/guacamole-server-{{ GUACAMOLE_VERSION }}
    - name: Build guacamole-server from source
      shell: ldconfig

- name: Copy over guacamole-{{ GUACAMOLE_VERSION }}.war
  copy: src="files/guacamole-{{ GUACAMOLE_VERSION }}.war" dest=/var/lib/{{ TOMCAT_VERSION }}/webapps/guacamole.war
  tags: file

- tags: clear-files
  block:
  - name: delete guacamole-server-{{ GUACAMOLE_VERSION }}.tar.gz
    file: path=/tmp/guacamole-server-{{ GUACAMOLE_VERSION }}.tar.gz state=absent
  - name: delete guacamole-server-{{ GUACAMOLE_VERSION }} directory
    file: path=/tmp/guacamole-server-{{ GUACAMOLE_VERSION }} state=absent

- name: Make '{{ GUACAMOLE_HOME }}' directory
  file: path='{{ GUACAMOLE_HOME }}' state=directory
  tags: configuration

- tags: database
  become: yes
  become_user: postgres
  block:
  
  - name: Copy over guacamole-auth source
    copy: src="files/guacamole-auth-jdbc-0.9.9.tar.gz" dest=/tmp/
  
  - name: Extract guacamole-auth
    unarchive: src="/tmp/guacamole-auth-jdbc-0.9.9.tar.gz" copy=no dest="/tmp/"
  
  - name: Make postgres user usable
    lineinfile:
      dest: /etc/postgresql/9.3/main/pg_hba.conf
      regexp: "^local   all             postgres" 
      line: "local   all             postgres                                peer"
      backrefs: true
      state: present
  
  - name: restart postgresql
    service: name=postgresql state=restarted
  
  - name: Create database
    postgresql_db:
      name: guacamole_db
      state: present
  
  - name: Run schema on guacamole_db
    shell: cat *.sql | psql -U postgres -d guacamole_db -f - chdir=/tmp/guacamole-auth-jdbc-0.9.9/postgresql/schema/
  
  - name: Create PostgreSQL guacamole user
    postgresql_user:
      name: guacamole_user
      password: guacamole_db_pass
      state: present
      db: guacamole_db
      priv: ALL
  
  - name: Change guacamole_user table privs
    postgresql_privs:
      db: guacamole_db
      role: guacamole_user
      objs: ALL_IN_SCHEMA
      privs: SELECT,INSERT,UPDATE,DELETE
      state: present
      type: table
  
  - name: Change guacamole_user sequence privs
    postgresql_privs:
      db: guacamole_db
      role: guacamole_user
      objs: ALL_IN_SCHEMA
      privs: SELECT,USAGE
      state: present
      type: sequence

- name: Create {{ GUACAMOLE_HOME }}/extensions directory
  file: path="{{ GUACAMOLE_HOME }}/extensions" state=directory
  tags: database

- name: Copy over guacamole-auth-jdbc-postgresql-0.9.9.jar to {{ GUACAMOLE_HOME }}/extensions
  copy:
    src: "/tmp/guacamole-auth-jdbc-0.9.9/postgresql/guacamole-auth-jdbc-postgresql-0.9.9.jar"
    remote_src: True
    dest: "{{ GUACAMOLE_HOME }}/extensions"
  tags: database

- name: Create {{ GUACAMOLE_HOME }}/lib directory
  file: path="{{ GUACAMOLE_HOME }}/lib" state=directory
  tags: database

- name: Copy over postgresql-9.4.1209.jre7.jar to {{ GUACAMOLE_HOME }}/lib
  copy:
    src: "files/postgresql-9.4.1209.jre7.jar"
    dest: "{{ GUACAMOLE_HOME }}/lib"
  tags: database
  
- name: Add guacamole.properties to "{{ GUACAMOLE_HOME }}"
  template: src="guacamole.properties.j2" dest="{{ GUACAMOLE_HOME }}/guacamole.properties"
  tags: template
  
- tags: restart
  block:
  - name: restart tomcat
    service: name={{ TOMCAT_VERSION }} state=restarted
  - name: restart postgresql
    service: name=postgresql state=restarted
  - name: restart guacd
    service: name=guacd state=restarted
    ignore_errors: yes
  